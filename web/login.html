<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      html {
        font-family: sans-serif;
        color: white;
        background: seagreen linear-gradient(315deg, rgba(255,255,255,0.2), transparent);
        height: 100%;
      }
      body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
      }
      div {
        margin: 1em;
      }
      #error {
        color: red;
      }
    </style>
    <script>
      function error(msg) {
        document.querySelector("#error").textContent = msg
      }

      async function login(evt) {
        evt.preventDefault()
        let data = new FormData(evt.target)
        let username = data.get("username")
        let password = data.get("password")

        let headers = new Headers({
          "Authorization": "Basic " + btoa(username + ":" + password),
          "X-Simpleauth-Login": "true",
        })

        let resp = await fetch(location.href, {
          method: "GET",
          headers: headers,
        })

        if (resp.status === 418) {
          // Browser automatically processes Set-Cookie header
          // 418 = authentication succeeded, cookie issued
          location.reload()
        } else {
          let statusMsg = resp.statusText || {
            401: "Not Authorized",
            429: "Rate Limited - please wait to try again",
            500: "Server Error",
            502: "Server Error"
          }[resp.status] || "Authentication failed"
          error(`Error ${resp.status}: ${statusMsg}`)
          // Clear password field on authentication failure
          document.querySelector("#password").value = ""
          // Focus password field so user can retry
          document.querySelector("#password").focus()
        }
      }

      async function init() {
        document.querySelector("form").addEventListener("submit", login)
      }

      window.addEventListener("load", init)
    </script>
  </head>
  <body>
    <h1>Login</h1>
    <form>
      <div><label for="username">Username: </label><input type="text" id="username" name="username" autocomplete="username" required autofocus></div>
      <div><label for="password">Password: </label><input type="password" id="password" name="password" autocomplete="current-password" required></div>
      <div><input type="submit" value="Log In"></div>
    </form>
    <div id="error"></div>
  </body>
</html>
